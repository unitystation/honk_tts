name: CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-and-test:
    name: Build and smoke test (${{ matrix.label }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            label: win64
            build_cmd: .\build.bat
          - os: ubuntu-latest
            label: lin64
            build_cmd: |
              chmod +x ./build.sh
              ./build.sh
          - os: macos-latest
            label: osx
            build_cmd: |
              chmod +x ./build.sh
              ./build.sh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ${{ matrix.build_cmd }}

      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: ${{ matrix.build_cmd }}

      - name: Smoke test output (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (!(Test-Path "build/tts_server.py")) { throw "Missing build/tts_server.py" }
          if (!(Test-Path "build/requirements.txt")) { throw "Missing build/requirements.txt" }
          if (!(Test-Path "build/scripts/start_tts.bat")) { throw "Missing build/scripts/start_tts.bat" }
          if (!(Test-Path "build/scripts/test_server.py")) { throw "Missing build/scripts/test_server.py" }
          if (!(Test-Path "build/HonkTTS.Installer.exe")) { throw "Missing build/HonkTTS.Installer.exe" }

      - name: Smoke test output (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          test -f build/tts_server.py
          test -f build/requirements.txt
          test -f build/scripts/start_tts.sh
          test -f build/scripts/test_server.py
          if [ -f build/HonkTTS.Installer ]; then
            echo "Found build/HonkTTS.Installer"
          elif [ -f build/HonkTTS.Installer.exe ]; then
            echo "Found build/HonkTTS.Installer.exe"
          else
            echo "Missing installer binary in build/"
            exit 1
          fi

      - name: Install eSpeak prerequisite (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y espeak-ng

      - name: Install eSpeak prerequisite (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          brew update
          brew install espeak-ng

      - name: Runtime installer test (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $installDir = Join-Path $env:RUNNER_TEMP "tts-install"
          & "build/HonkTTS.Installer.exe" $installDir
          if ($LASTEXITCODE -ne 0) { throw "Installer failed with exit code $LASTEXITCODE" }
          & (Join-Path $installDir "test_tts.bat") --fail-warnings
          if ($LASTEXITCODE -ne 0) { throw "test_tts.bat failed with exit code $LASTEXITCODE" }

      - name: Runtime installer test (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          install_dir="$RUNNER_TEMP/tts-install"
          if [ -f build/HonkTTS.Installer ]; then
            chmod +x build/HonkTTS.Installer
            build/HonkTTS.Installer "$install_dir"
          else
            build/HonkTTS.Installer.exe "$install_dir"
          fi
          chmod +x "$install_dir/test_tts.sh"
          "$install_dir/test_tts.sh"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.label }}
          path: build/*
          if-no-files-found: error
